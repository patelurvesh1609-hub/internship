PART 1ï¸âƒ£ â€” CREATE MODELS & MIGRATIONS

1ï¸âƒ£ Create User Model (Already Exists)

app/Models/User.php

2ï¸âƒ£ Create Role Model + Migration

ğŸ“Œ Command
php artisan make:model Role -m

app/Models/Role.php
database/migrations/xxxx_xx_xx_create_roles_table.php

ğŸ“„ Migration
Schema::create('roles', function (Blueprint $table) {
    $table->id();
    $table->string('name');
    $table->timestamps();
});

3ï¸âƒ£ Create Pivot Table Migration (IMPORTANT ğŸ”¥)

ğŸ“Œ Command
php artisan make:migration create_role_user_table

database/migrations/xxxx_xx_xx_create_role_user_table.php

Schema::create('role_user', function (Blueprint $table) {
    $table->id();

    $table->foreignId('user_id')
          ->constrained()
          ->onDelete('cascade');

    $table->foreignId('role_id')
          ->constrained()
          ->onDelete('cascade');
});

php artisan migrate

PART 2ï¸âƒ£ â€” DEFINE RELATIONSHIPS IN MODELS

4ï¸âƒ£ User Model (belongsToMany)

app/Models/User.php

use App\Models\Role;

public function roles()
{
    return $this->belongsToMany(Role::class);
}

5ï¸âƒ£ Role Model (belongsToMany)

app/Models/Role.php

use App\Models\User;

class Role extends Model
{
    protected $fillable = ['name'];

    public function users()
    {
        return $this->belongsToMany(User::class);
    }
}

PART 3ï¸âƒ£ â€” USING THE MANY-TO-MANY RELATIONSHIP

6ï¸âƒ£ Attach Roles to User
$user = User::find(1);
$user->roles()->attach(1); // role_id = 1

7ï¸âƒ£ Attach Multiple Roles
$user->roles()->attach([1, 2, 3]);

8ï¸âƒ£ Sync Roles (MOST USED ğŸ”¥)
$user->roles()->sync([2, 3]);

9ï¸âƒ£ Detach Role
$user->roles()->detach(1);

ğŸ”Ÿ Get Roles of a User
$user = User::find(1);

foreach ($user->roles as $role) {
    echo $role->name;
}

ğŸ”Ÿ Get Users of a Role
$role = Role::find(1);

foreach ($role->users as $user) {
    echo $user->name;
}

PART 4ï¸âƒ£ â€” CONTROLLER EXAMPLE

app/Http/Controllers/UserRoleController.php

use App\Models\User;
use App\Models\Role;

class UserRoleController extends Controller
{
    public function assignRole()
    {
        $user = User::find(1);
        $user->roles()->sync([1, 2]);

        return "Roles Assigned";
    }
}

PART 5ï¸âƒ£ â€” PIVOT TABLE WITH EXTRA COLUMNS (ADVANCED ğŸ”¥)

$table->timestamp('assigned_at')->nullable();

return $this->belongsToMany(Role::class)
            ->withPivot('assigned_at');

foreach ($user->roles as $role) {
    echo $role->pivot->assigned_at;
}
